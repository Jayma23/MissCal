<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Miss Cal</title>
    <link rel="stylesheet" href="formPage.css">
    <style>
        /* Additional styles for interactive elements */
        .progress-container {
            width: 100%;
            margin: 20px 0;
        }
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s ease;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
        }
        .preview-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 5px;
            display: none;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .character-counter {
            color: #666;
            font-size: 0.8em;
            text-align: right;
            margin-top: 5px;
        }
        .field-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }
        .field-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .field-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        /* New styles for multiple image uploads */
        .photos-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .photo-item {
            position: relative;
            width: 200px;
            margin-bottom: 15px;
        }
        .photo-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .photo-caption {
            width: 100%;
            margin-top: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .add-photo-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 200px;
            background-color: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 5px;
            cursor: pointer;
            font-size: 24px;
            color: #666;
        }
        .add-photo-btn:hover {
            background-color: #e8e8e8;
        }
        .photo-counter {
            margin-top: 5px;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
<header class="main-header">
    <div class="container">
        <h1 class="title">Join Miss Cal</h1>
        <p class="subtitle">Showcase your talent, confidence, and story to be part of Miss Cal!</p>
    </div>
</header>

<main class="form-container">
    <button id="sidebarToggle" class="sidebar-toggle">☰ </button>
    <aside class="sidebar hidden" id="sidebar">
        <h3>Dashboard</h3>
        <ul>
            <li><a href="mainPage.html">Home</a></li>
            <li><a href="formPage.html">Join the Pageant</a></li>
            <li><a href="vote.html">Vote</a></li>
            <li><a href="rule.html">Rules</a></li>
            <li><a href="profile.html">My Profile</a></li>
            <li><a id="logoffButton" class="btn btn-danger w-100">Log Off</a></li>
        </ul>
    </aside>

    <!-- Progress tracker -->
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="progressText">Step 1 of 4: Basic Information</p>
    </div>

    <form id="joinForm" action="/submitForm" method="POST" enctype="multipart/form-data">
        <!-- Step 1: Basic Information -->
        <div class="form-step active" id="step1">
            <h2>Basic Information</h2>
            <label for="name">Full Name: <span class="field-tooltip">ⓘ<span class="tooltip-text">Please enter your full legal name as it appears on your ID</span></span></label>
            <input type="text" id="name" name="name" placeholder="Enter your name" required>

            <label for="major">Major: <span class="field-tooltip">ⓘ<span class="tooltip-text">Your current academic major</span></span></label>
            <input type="text" id="major" name="major" placeholder="Enter your major">

            <label for="year">Year: <span class="field-tooltip">ⓘ<span class="tooltip-text">Year of Graduation</span></span></label>
            <input type="number" id="year" name="year" placeholder="Enter your Year of Graduation">


            <label for="gpa">GPA: <span class="field-tooltip">ⓘ<span class="tooltip-text">Your current cumulative GPA on a 4.0 scale</span></span></label>
            <input type="number" id="gpa" name="gpa" step="0.01" placeholder="Enter your GPA" min="0" max="4.0">

            <div class="nav-buttons">
                <div></div> <!-- Empty div for spacing -->
                <button type="button" id="nextToStep2">Next: Photo Upload</button>
            </div>
        </div>

        <!-- Step 2: Photo Upload (Updated for multiple photos) -->
        <div class="form-step" id="step2">
            <h2>Photo Upload</h2>
            <label for="photos">Upload Photos (Up to 5): <span class="field-tooltip">ⓘ<span class="tooltip-text">Choose up to 5 high-quality photos that best represent you</span></span></label>

            <!-- Hidden file input that will be triggered by our custom UI -->
            <input type="file" id="photoInput" name="photoInput" accept="image/*" style="display: none">

            <div class="photo-counter">Selected: <span id="photoCount">0</span>/5 photos</div>

            <!-- Container for photo previews -->
            <div class="photos-container" id="photosContainer">
                <div id="addPhotoButton" class="add-photo-btn">+</div>
            </div>

            <div class="nav-buttons">
                <button type="button" id="backToStep1">Back</button>
                <button type="button" id="nextToStep3">Next: Your Story</button>
            </div>
        </div>

        <!-- Step 3: Personal Story -->
        <div class="form-step" id="step3">
            <h2>Your Story</h2>
            <label for="campaign_line">Campaign Line (50 words max): <span class="field-tooltip">ⓘ<span class="tooltip-text">A short, memorable slogan or phrase that represents your candidacy</span></span></label>
            <textarea id="campaign_line" name="campaign_line" maxlength="250" placeholder="Write your campaign line"></textarea>
            <div class="character-counter" id="campaignLineCounter">0/50 words</div>

            <label for="personal_story">Personal Story (200 words max): <span class="field-tooltip">ⓘ<span class="tooltip-text">Share your journey, challenges overcome, and what makes you unique</span></span></label>
            <textarea id="personal_story" name="personal_story" maxlength="1000" placeholder="Share your story"></textarea>
            <div class="character-counter" id="personalStoryCounter">0/200 words</div>

            <label for="experience">Professional Experience: <span class="field-tooltip">ⓘ<span class="tooltip-text">List relevant internships, jobs, or other professional experience</span></span></label>
            <textarea id="experience" name="experience" placeholder="List internships, jobs, or other experience"></textarea>

            <label for="organizations">School Organizations: <span class="field-tooltip">ⓘ<span class="tooltip-text">Clubs, sororities, or other campus affiliations</span></span></label>
            <textarea id="organizations" name="organizations" placeholder="Clubs, sororities, or other affiliations"></textarea>

            <div class="nav-buttons">
                <button type="button" id="backToStep2">Back</button>
                <button type="button" id="nextToStep4">Next: Social Media</button>
            </div>
        </div>

        <!-- Step 4: Social Media -->
        <div class="form-step" id="step4">
            <h2>Social Media Links</h2>
            <label for="instagram">Instagram: <span class="field-tooltip">ⓘ<span class="tooltip-text">Your Instagram profile URL</span></span></label>
            <input type="url" id="instagram" name="instagram" placeholder="https://instagram.com/your-profile">

            <label for="linkedin">LinkedIn: <span class="field-tooltip">ⓘ<span class="tooltip-text">Your LinkedIn profile URL</span></span></label>
            <input type="url" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/your-profile">

            <label for="facebook">Facebook: <span class="field-tooltip">ⓘ<span class="tooltip-text">Your Facebook profile URL</span></span></label>
            <input type="url" id="facebook" name="facebook" placeholder="https://facebook.com/your-profile">

            <label for="github">GitHub: <span class="field-tooltip">ⓘ<span class="tooltip-text">Your GitHub profile URL</span></span></label>
            <input type="url" id="github" name="github" placeholder="https://github.com/your-profile">

            <label for="snapchat">Snapchat: <span class="field-tooltip">ⓘ<span class="tooltip-text">Your Snapchat username</span></span></label>
            <input type="url" id="snapchat" name="snapchat" placeholder="Your Snapchat username or link">

            <label for="tiktok">TikTok: <span class="field-tooltip">ⓘ<span class="tooltip-text">Your TikTok profile URL</span></span></label>
            <input type="url" id="tiktok" name="tiktok" placeholder="https://tiktok.com/@your-profile">

            <div class="preview-container">
                <h3>Application Preview</h3>
                <div id="applicationPreview">
                    <p>Complete the form to see your application preview</p>
                </div>
            </div>

            <div class="nav-buttons">
                <button type="button" id="backToStep3">Back</button>
                <button type="submit" id="submitButton">Submit Application</button>
            </div>
        </div>
    </form>
</main>

<footer class="footer">
    <p>&copy; 2024 College Life. All rights reserved.</p>
</footer>

<script>
    // Sidebar toggle functionality
    const sidebar = document.getElementById("sidebar");
    const sidebarToggle = document.getElementById("sidebarToggle");

    sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("show");
    });

    // Logout functionality
    document.getElementById("logoffButton").addEventListener("click", async () => {
        try {
            const response = await fetch("https://server1.misscal.net/logout", {
                method: "POST",
                credentials: "include",
            });

            if (response.ok) {
                document.cookie = "user_id=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
                alert("You have been logged out.");
                window.location.href = "sign-in.html";
            } else {
                alert("Logoff failed. Please try again.");
            }
        } catch (error) {
            console.error("Error logging out:", error);
            alert("An error occurred while logging out.");
        }
    });

    // Multi-step form navigation
    const steps = ["step1", "step2", "step3", "step4"];
    let currentStep = 0;

    function updateProgressBar() {
        const progressPercentage = (currentStep / (steps.length - 1)) * 100;
        document.getElementById("progressFill").style.width = `${progressPercentage}%`;
        document.getElementById("progressText").textContent = `Step ${currentStep + 1} of ${steps.length}: ${getStepName(currentStep)}`;
    }

    function getStepName(step) {
        const names = ["Basic Information", "Photo Upload", "Your Story", "Social Media"];
        return names[step];
    }

    function showStep(stepIndex) {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(step => {
            step.classList.remove('active');
        });

        // Show the selected step
        document.getElementById(steps[stepIndex]).classList.add('active');

        // Update progress bar
        currentStep = stepIndex;
        updateProgressBar();
    }

    // Navigation buttons
    document.getElementById("nextToStep2").addEventListener("click", () => {
        if (!document.getElementById("name").value) {
            alert("Please enter your name before proceeding.");
            return;
        }
        showStep(1);
    });

    document.getElementById("nextToStep3").addEventListener("click", () => {
        const photoCount = document.querySelectorAll('.photo-item').length;
        if (photoCount === 0) {
            alert("Please upload at least one photo before proceeding.");
            return;
        }
        showStep(2);
    });

    document.getElementById("nextToStep4").addEventListener("click", () => {
        showStep(3);
        updateApplicationPreview();
    });

    document.getElementById("backToStep1").addEventListener("click", () => {
        showStep(0);
    });

    document.getElementById("backToStep2").addEventListener("click", () => {
        showStep(1);
    });

    document.getElementById("backToStep3").addEventListener("click", () => {
        showStep(2);
    });

    // Word counters
    function countWords(text) {
        return text.trim().split(/\s+/).filter(Boolean).length;
    }

    document.getElementById("campaign_line").addEventListener("input", function() {
        const wordCount = countWords(this.value);
        const counter = document.getElementById("campaignLineCounter");
        counter.textContent = `${wordCount}/50 words`;

        if (wordCount > 50) {
            counter.style.color = "red";
        } else {
            counter.style.color = "#666";
        }
    });

    document.getElementById("personal_story").addEventListener("input", function() {
        const wordCount = countWords(this.value);
        const counter = document.getElementById("personalStoryCounter");
        counter.textContent = `${wordCount}/200 words`;

        if (wordCount > 200) {
            counter.style.color = "red";
        } else {
            counter.style.color = "#666";
        }
    });

    // Multiple Image Upload Functionality
    const photosContainer = document.getElementById("photosContainer");
    const photoInput = document.getElementById("photoInput");
    const addPhotoButton = document.getElementById("addPhotoButton");
    const photoCountDisplay = document.getElementById("photoCount");
    const uploadedPhotos = new Map(); // Store photo data with unique IDs
    let photoCounter = 0;

    // Click on the add photo button to trigger file input
    addPhotoButton.addEventListener("click", () => {
        if (uploadedPhotos.size >= 5) {
            alert("You can upload a maximum of 5 photos.");
            return;
        }
        photoInput.click();
    });

    // Handle file selection
    photoInput.addEventListener("change", function() {
        const file = this.files[0];
        if (!file) return;

        if (uploadedPhotos.size >= 5) {
            alert("You can upload a maximum of 5 photos.");
            return;
        }

        // Check file type
        if (!file.type.match('image.*')) {
            alert("Please upload an image file.");
            return;
        }

        // Generate a unique ID for this photo
        const photoId = `photo_${photoCounter++}`;

        // Create photo preview element
        const photoItem = document.createElement("div");
        photoItem.className = "photo-item";
        photoItem.dataset.id = photoId;

        const reader = new FileReader();
        reader.onload = function(e) {
            // Store the photo data
            uploadedPhotos.set(photoId, {
                file: file,
                dataUrl: e.target.result,
                caption: ""
            });

            // Update the UI
            photoItem.innerHTML = `
                <img src="${e.target.result}" class="photo-preview">
                <button type="button" class="photo-remove">×</button>
                <input type="text" class="photo-caption" placeholder="Add a caption..." data-id="${photoId}">
            `;
            photosContainer.insertBefore(photoItem, addPhotoButton);

            // Add remove button functionality
            photoItem.querySelector('.photo-remove').addEventListener('click', function() {
                uploadedPhotos.delete(photoId);
                photoItem.remove();
                updatePhotoCount();

                // Show add button if it was hidden
                if (addPhotoButton.style.display === 'none') {
                    addPhotoButton.style.display = 'flex';
                }
            });

            // Add caption functionality
            photoItem.querySelector('.photo-caption').addEventListener('input', function() {
                const photoData = uploadedPhotos.get(photoId);
                if (photoData) {
                    photoData.caption = this.value;
                    uploadedPhotos.set(photoId, photoData);
                }
            });

            updatePhotoCount();

            // Hide add button if max photos reached
            if (uploadedPhotos.size >= 5) {
                addPhotoButton.style.display = 'none';
            }
        }

        reader.readAsDataURL(file);
    });

    function updatePhotoCount() {
        const count = uploadedPhotos.size;
        photoCountDisplay.textContent = count;

        // Update visibility of add button
        addPhotoButton.style.display = count >= 5 ? 'none' : 'flex';
    }

    // Application preview
    function updateApplicationPreview() {
        const name = document.getElementById("name").value;
        const major = document.getElementById("major").value;
        const campaignLine = document.getElementById("campaign_line").value;

        let previewHTML = "";

        if (name) {
            previewHTML += `<p><strong>Name:</strong> ${name}</p>`;
        }

        if (major) {
            previewHTML += `<p><strong>Major:</strong> ${major}</p>`;
        }

        if (campaignLine) {
            previewHTML += `<p><strong>Campaign Line:</strong> ${campaignLine}</p>`;
        }

        if (uploadedPhotos.size > 0) {
            previewHTML += `<p><strong>Photos:</strong> ${uploadedPhotos.size} uploaded ✓</p>`;
        }

        if (previewHTML === "") {
            previewHTML = "<p>Complete the form to see your application preview</p>";
        }

        document.getElementById("applicationPreview").innerHTML = previewHTML;
    }

    // Form submission
    document.getElementById("joinForm").addEventListener("submit", async (event) => {
        event.preventDefault();

        // Validate form
        const name = document.getElementById("name").value;

        if (!name) {
            alert("Please enter your name.");
            showStep(0);
            return;
        }

        if (uploadedPhotos.size === 0) {
            alert("Please upload at least one photo.");
            showStep(1);
            return;
        }

        // Check word counts
        const campaignLineWordCount = countWords(document.getElementById("campaign_line").value);
        const personalStoryWordCount = countWords(document.getElementById("personal_story").value);

        if (campaignLineWordCount > 50) {
            alert("Your campaign line exceeds the 50-word limit. Please edit it before submitting.");
            showStep(2);
            return;
        }

        if (personalStoryWordCount > 200) {
            alert("Your personal story exceeds the 200-word limit. Please edit it before submitting.");
            showStep(2);
            return;
        }

        const formData = new FormData(event.target);

        // Add photos to formData
        uploadedPhotos.forEach((photoData, photoId) => {
            formData.append('photos[]', photoData.file);
            formData.append(`caption_${photoId}`, photoData.caption);
        });

        // Retrieve user_id from the cookie
        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        };

        const userId = getCookie("user_id");
        if (!userId) {
            alert("You need to log in first!");
            return;
        }

        // Append the user_id to the form data
        formData.append("user_id", userId);

        try {
            const response = await fetch("https://server1.misscal.net/submitForm", {
                method: "POST",
                body: formData,
                credentials: "include",
            });

            if (response.ok) {
                alert("Form submitted successfully!");
                window.location.href = "mainPage.html";
            } else {
                const error = await response.json();
                alert(error.message || "Form submission failed. Please try again.");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while submitting the form. Please try again later.");
        }
    });

    // Initialize progress bar
    updateProgressBar();

    // Add event listeners for real-time validation and preview updates
    const formInputs = document.querySelectorAll('input, textarea');
    formInputs.forEach(input => {
        input.addEventListener('input', function() {
            if (currentStep === 3) {
                updateApplicationPreview();
            }
        });
    });
</script>
</body>
</html>