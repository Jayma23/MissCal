<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign In - Miss Cal</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #FDB515, #FFD700);
            color: #FDB515;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-header {
            background: #003262;
            color: white;
            padding: 60px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .main-header::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: url('https://server1.misscal.net/assets/campus-pattern.png');
            opacity: 0.1;
            z-index: 0;
        }

        .main-header .title {
            font-family: 'Roboto', sans-serif;
            font-size: 3rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .main-header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .auth-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 15px;
            background: transparent;
        }

        .auth-box {
            background: #fff;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            max-width: 420px;
            width: 100%;
            animation: fadeInUp 0.6s ease-out;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .auth-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
        }

        .auth-box h2 {
            color: #003262;
            margin-bottom: 30px;
            font-size: 1.9rem;
        }

        .form-label {
            font-weight: 600;
            color: #003262;
        }

        .form-control {
            border-radius: 8px;
            padding: 12px 14px;
            transition: all 0.3s;
            border: 2px solid #e9ecef;
        }

        .form-control:focus {
            border-color: #003262;
            box-shadow: 0 0 0 0.2rem rgba(0, 50, 98, 0.25);
            transform: translateY(-2px);
        }

        .btn-custom {
            background: #003262;
            color: white;
            transition: all 0.3s;
            font-weight: 600;
            border-radius: 50px;
            padding: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn-custom::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-custom:hover {
            background: #001F3F;
            transform: scale(1.05);
        }

        .btn-custom:hover::after {
            width: 200%;
            height: 200%;
        }

        .signup-prompt {
            margin-top: 20px;
            text-align: center;
            color: black;
        }

        .signup-prompt a {
            color: #003262;
            font-weight: 600;
            text-decoration: none;
            position: relative;
            transition: all 0.3s;
        }

        .signup-prompt a::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            bottom: -2px;
            left: 0;
            background-color: #FDB515;
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s;
        }

        .signup-prompt a:hover {
            color: #FDB515;
        }

        .signup-prompt a:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .footer {
            background: #003262;
            color: #e0a814;
            text-align: center;
            padding: 15px 0;
            font-size: 0.9rem;
        }

        .password-toggle {
            cursor: pointer;
            transition: all 0.2s;
        }

        .password-toggle:hover {
            color: #003262;
        }

        .input-group-text {
            transition: all 0.3s;
        }

        .input-field-active .input-group-text {
            background-color: #003262;
            color: white;
            border-color: #003262;
        }

        .auth-mode-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .dark-mode-toggle {
            width: 60px;
            height: 30px;
            border-radius: 15px;
            background: #e9ecef;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dark-mode-toggle::after {
            content: "";
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #003262;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #001F3F, #003262);
            color: #e0a814;
        }

        body.dark-mode .auth-box {
            background: #1a1a1a;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .auth-box h2,
        body.dark-mode .form-label {
            color: #FDB515;
        }

        body.dark-mode .form-control {
            background: #333;
            border-color: #444;
            color: white;
        }

        body.dark-mode .input-group-text {
            background: #444;
            border-color: #444;
            color: #FDB515;
        }

        body.dark-mode .btn-custom {
            background: #FDB515;
            color: #003262;
        }

        body.dark-mode .btn-custom:hover {
            background: #e0a814;
        }

        body.dark-mode .signup-prompt {
            color: #ddd;
        }

        body.dark-mode .signup-prompt a {
            color: #FDB515;
        }

        body.dark-mode .dark-mode-toggle {
            background: #666;
        }

        body.dark-mode .dark-mode-toggle::after {
            left: 32px;
            background: #FDB515;
        }

        .toast-container .toast {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .typing-animation::after {
            content: '|';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .remember-me {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .remember-me input {
            margin-right: 0.5rem;
        }

        .auth-options {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .forgot-password {
            color: #003262;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s;
        }

        .forgot-password:hover {
            color: #FDB515;
            text-decoration: underline;
        }

        .oauth-buttons {
            margin-top: 1.5rem;
            text-align: center;
            position: relative;
        }

        .oauth-buttons::before {
            content: 'OR';
            display: inline-block;
            background: white;
            padding: 0 10px;
            position: relative;
            top: -10px;
            font-size: 0.8rem;
            color: #777;
        }

        .oauth-buttons::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
            z-index: -1;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 5px;
            background: white;
            border: 1px solid #ddd;
            transition: all 0.3s;
            color: #555;
        }

        .social-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .social-btn.google:hover {
            color: #DB4437;
            border-color: #DB4437;
        }

        .social-btn.facebook:hover {
            color: #4267B2;
            border-color: #4267B2;
        }

        body.dark-mode .oauth-buttons::before {
            background: #1a1a1a;
            color: #999;
        }

        body.dark-mode .social-btn {
            background: #333;
            border-color: #444;
            color: #ddd;
        }
    </style>
</head>
<body>

<div class="auth-mode-switch">
    <div class="dark-mode-toggle" id="darkModeToggle"></div>
</div>

<header class="main-header">
    <div class="container">
        <h1 class="title" id="welcomeTitle">Welcome to Miss Cal</h1>
    </div>
</header>

<main class="auth-container">
    <div class="auth-box">
        <h2 class="text-center">Sign In</h2>
        <form id="signInForm">
            <div class="mb-3">
                <label for="email" class="form-label">UC Berkeley Email:</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-envelope-fill text-secondary"></i></span>
                    <input type="email" id="email" name="email" class="form-control" placeholder="you@berkeley.edu" required />
                </div>
                <div class="form-text text-muted email-suggestion" id="emailSuggestion"></div>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password:</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-lock-fill text-secondary"></i></span>
                    <input type="password" id="password" name="password" class="form-control" placeholder="Enter your password" required />
                    <span class="input-group-text bg-light password-toggle" id="togglePassword">
                        <i class="bi bi-eye-fill"></i>
                    </span>
                </div>
                <div class="password-strength mt-2" id="passwordStrength"></div>
            </div>
            <div class="auth-options">
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe" name="rememberMe" />
                    <label for="rememberMe">Remember me</label>
                </div>
                <a href="#" class="forgot-password" id="forgotPassword">Forgot Password?</a>
            </div>
            <button type="submit" class="btn btn-custom w-100" id="signInBtn">
                <span>Sign In</span>
            </button>
        </form>
        <div class="oauth-buttons">
            <a href="#" class="social-btn google"><i class="bi bi-google"></i></a>
            <a href="#" class="social-btn facebook"><i class="bi bi-facebook"></i></a>
        </div>
        <p class="signup-prompt">Don't have an account? <a href="signup.html" id="signupLink">Sign Up</a></p>
    </div>
</main>

<footer class="footer">
    <p>&copy; 2024 College Life. All rights reserved.</p>
</footer>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="toast-container"></div>
</div>

<!-- Forgot Password Modal -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Enter your email address to receive a password reset link.</p>
                <div class="mb-3">
                    <input type="email" class="form-control" id="resetEmail" placeholder="you@berkeley.edu" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-custom" id="sendResetBtn">Send Reset Link</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase Placeholder -->
<script type="module">
    // Initialize Firebase
</script>

<!-- Login logic with enhanced interactivity -->
<script>
    // DOM Elements
    const form = document.getElementById("signInForm");
    const btn = document.getElementById("signInBtn");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const togglePassword = document.getElementById("togglePassword");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const welcomeTitle = document.getElementById("welcomeTitle");
    const emailSuggestion = document.getElementById("emailSuggestion");
    const passwordStrength = document.getElementById("passwordStrength");
    const forgotPasswordLink = document.getElementById("forgotPassword");
    const forgotPasswordModal = new bootstrap.Modal(document.getElementById("forgotPasswordModal"), {});
    const sendResetBtn = document.getElementById("sendResetBtn");
    const signupLink = document.getElementById("signupLink");

    // Welcome text typing animation
    let welcomeText = "Welcome to Miss Cal";
    let index = 0;
    welcomeTitle.textContent = "";
    welcomeTitle.classList.add("typing-animation");

    function typeText() {
        if (index < welcomeText.length) {
            welcomeTitle.textContent += welcomeText.charAt(index);
            index++;
            setTimeout(typeText, 100);
        } else {
            welcomeTitle.classList.remove("typing-animation");
        }
    }

    setTimeout(typeText, 500);

    // Dark mode toggle
    const isDarkMode = localStorage.getItem("darkMode") === "true";
    if (isDarkMode) {
        document.body.classList.add("dark-mode");
    }

    darkModeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
    });

    // Password visibility toggle
    togglePassword.addEventListener("click", () => {
        const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
        passwordInput.setAttribute("type", type);
        togglePassword.querySelector("i").classList.toggle("bi-eye-fill");
        togglePassword.querySelector("i").classList.toggle("bi-eye-slash-fill");
    });

    // Input field focus effects
    const inputGroups = document.querySelectorAll(".input-group");
    inputGroups.forEach(group => {
        const input = group.querySelector("input");
        input.addEventListener("focus", () => {
            group.classList.add("input-field-active");
        });
        input.addEventListener("blur", () => {
            if (!input.value) {
                group.classList.remove("input-field-active");
            }
        });
    });

    // Email validation and suggestion
    emailInput.addEventListener("blur", () => {
        const email = emailInput.value.trim();
        if (email && !email.endsWith("@berkeley.edu")) {
            // Check if it's a likely berkeley email with typo
            if (email.includes("@") && (
                email.endsWith("@berkley.edu") ||
                email.endsWith("@berkeley.com") ||
                email.endsWith("@berkeley.org") ||
                email.includes("berkeley"))) {
                emailSuggestion.textContent = "Did you mean " + email.split("@")[0] + "@berkeley.edu?";
                emailSuggestion.style.cursor = "pointer";
                emailSuggestion.addEventListener("click", () => {
                    emailInput.value = email.split("@")[0] + "@berkeley.edu";
                    emailSuggestion.textContent = "";
                });
            } else if (!email.includes("@berkeley.edu")) {
                emailSuggestion.textContent = "Please use your UC Berkeley email address.";
            }
        } else {
            emailSuggestion.textContent = "";
        }
    });

    // Simple password strength meter
    passwordInput.addEventListener("input", () => {
        const password = passwordInput.value;
        let strength = 0;

        // Length check
        if (password.length >= 8) strength += 25;

        // Character variety checks
        if (/[A-Z]/.test(password)) strength += 25; // Uppercase
        if (/[0-9]/.test(password)) strength += 25; // Numbers
        if (/[^A-Za-z0-9]/.test(password)) strength += 25; // Special chars

        let strengthText = '';
        let strengthClass = '';

        if (password.length === 0) {
            strengthText = '';
        } else if (strength < 50) {
            strengthText = 'Weak';
            strengthClass = 'text-danger';
        } else if (strength < 75) {
            strengthText = 'Moderate';
            strengthClass = 'text-warning';
        } else {
            strengthText = 'Strong';
            strengthClass = 'text-success';
        }

        passwordStrength.innerHTML = password.length > 0 ?
            `<div class="progress" style="height: 5px">
                <div class="progress-bar bg-${strengthClass.split('-')[1]}" style="width: ${strength}%"></div>
            </div>
            <small class="${strengthClass} mt-1 d-inline-block">${strengthText}</small>` : '';
    });

    // Forgot password handling
    forgotPasswordLink.addEventListener("click", (e) => {
        e.preventDefault();
        forgotPasswordModal.show();

        // Prefill email if one is entered in the login form
        if (emailInput.value) {
            document.getElementById("resetEmail").value = emailInput.value;
        }
    });

    // Password reset request
    sendResetBtn.addEventListener("click", async () => {
        const resetEmail = document.getElementById("resetEmail").value;
        if (!resetEmail) {
            showToast("Please enter your email address", "warning");
            return;
        }

        sendResetBtn.disabled = true;
        sendResetBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Sending...';

        // Simulate API call
        setTimeout(() => {
            forgotPasswordModal.hide();
            showToast("Password reset link sent to your email!", "success");
            sendResetBtn.disabled = false;
            sendResetBtn.innerHTML = 'Send Reset Link';
        }, 1500);
    });

    // Sign up link animation
    signupLink.addEventListener("mouseenter", () => {
        signupLink.style.transform = "scale(1.05)";
    });

    signupLink.addEventListener("mouseleave", () => {
        signupLink.style.transform = "scale(1)";
    });

    // Form submission with enhanced UX
    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const email = emailInput.value;
        const password = passwordInput.value;
        const rememberMe = document.getElementById("rememberMe").checked;

        // Basic form validation with UI feedback
        if (!email.endsWith("@berkeley.edu")) {
            emailInput.classList.add("is-invalid");
            showToast("Please use your UC Berkeley email", "warning");
            return;
        } else {
            emailInput.classList.remove("is-invalid");
        }

        if (password.length < 6) {
            passwordInput.classList.add("is-invalid");
            showToast("Password must be at least 6 characters", "warning");
            return;
        } else {
            passwordInput.classList.remove("is-invalid");
        }

        // Update button state
        btn.disabled = true;
        const originalBtnText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Signing in...';

        try {
            // Simulate API call (replace with actual call)
            await new Promise(resolve => setTimeout(resolve, 1500));

            const response = await fetch("https://server1.misscal.net/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ email, password, rememberMe }),
            });

            if (response.ok) {
                const data = await response.json();

                // Store user data
                document.cookie = `user_id=${data.user.id}; path=/; max-age=${rememberMe ? 7 * 24 * 60 * 60 : 24 * 60 * 60}; secure=${window.location.protocol === 'https:'};`;
                localStorage.setItem("lastLogin", new Date().toISOString());

                // Success animation
                btn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> Success!';
                btn.classList.add("btn-success");

                // Show toast and redirect
                showToast("Welcome back to Miss Cal!", "success");

                setTimeout(() => {
                    const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || 'mainPage.html';
                    window.location.href = redirectUrl;
                }, 1500);
            } else {
                const error = await response.json();
                showToast(error.message || "Login failed. Please check your credentials.", "danger");

                // Shake animation for form
                const authBox = document.querySelector('.auth-box');
                authBox.style.animation = 'none';
                setTimeout(() => {
                    authBox.style.animation = 'shake 0.5s';
                }, 10);
            }
        } catch (error) {
            console.error("Error:", error);
            showToast("Connection error. Please try again later.", "danger");
        } finally {
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
                btn.classList.remove("btn-success");
            }, 2000);
        }
    });

    // Enhanced toast function
    function showToast(message, type) {
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-bg-${type} border-0 mb-3`;
        toast.role = "alert";
        toast.setAttribute("aria-live", "assertive");
        toast.setAttribute("aria-atomic", "true");

        // Add appropriate icon based on toast type
        let icon = "info-circle-fill";
        if (type === "success") icon = "check-circle-fill";
        if (type === "danger") icon = "exclamation-triangle-fill";
        if (type === "warning") icon = "exclamation-circle-fill";

        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${icon} me-2"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        document.getElementById("toast-container").appendChild(toast);

        // Add a slight delay before showing the toast for a better animation effect
        setTimeout(() => {
            const bsToast = new bootstrap.Toast(toast, {
                animation: true,
                autohide: true,
                delay: 3000
            });
            bsToast.show();
        }, 100);

        // Remove the toast after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }

    // Add shake animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    `;
    document.head.appendChild(style);

    // Social login buttons
    document.querySelectorAll('.social-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            showToast(`${btn.classList.contains('google') ? 'Google' : 'Facebook'} login coming soon!`, "info");
        });
    });

    // Check if user was previously logged in
    window.addEventListener('load', () => {
        const lastLogin = localStorage.getItem("lastLogin");
        if (lastLogin) {
            const lastLoginDate = new Date(lastLogin);
            const now = new Date();
            const daysSinceLogin = Math.floor((now - lastLoginDate) / (1000 * 60 * 60 * 24));

            if (daysSinceLogin < 7) {
                emailSuggestion.innerHTML = `<span class="text-success">Welcome back! You last logged in ${daysSinceLogin === 0 ? 'today' : daysSinceLogin === 1 ? 'yesterday' : daysSinceLogin + ' days ago'}.</span>`;
            }
        }
    });
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>